<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Toolbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF manipulation library -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- Drag-and-drop library -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- PDF rendering library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .file-item, .page-thumbnail { transition: background-color 0.2s; }
        .file-item:hover { background-color: #374151; }
        .sortable-ghost { opacity: 0.4; background: #4f46e5; }
        .sortable-drag { opacity: 1 !important; }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; transition: opacity 0.3s ease;
        }
        .modal-content {
            max-height: 90vh;
            width: 90vw;
            max-width: 1200px;
        }
        .page-thumbnail {
            position: relative;
            border: 1px solid #4b5563;
            background-color: #374151;
            overflow: hidden;
            aspect-ratio: 7/9; /* Common PDF aspect ratio */
        }
        .page-thumbnail canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .page-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 0.25rem;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 40%);
        }
        .delete-page-btn {
            position: absolute;
            top: 4px; right: 4px;
            width: 24px; height: 24px;
            background-color: rgba(239, 68, 68, 0.8);
            color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .page-thumbnail:hover .delete-page-btn { opacity: 1; }
        .page-number { font-size: 0.75rem; color: white; text-shadow: 1px 1px 2px black; align-self: flex-end; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-400">PDF Toolbox</h1>
                <p class="text-gray-400 mt-2">Merge files, reorder pages, and delete pages. All in your browser.</p>
            </header>

            <main>
                <!-- File Drop Area -->
                <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-gray-700/50 transition-colors duration-300">
                    <input type="file" id="file-input" class="hidden" multiple accept=".pdf,application/pdf">
                    <div class="flex flex-col items-center">
                        <i class="fa-solid fa-file-arrow-up text-4xl text-gray-500 mb-4"></i>
                        <p class="text-lg font-medium">Drag & Drop PDF files here</p>
                        <p class="text-gray-400">or</p>
                        <button id="browse-btn" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Browse Files</button>
                    </div>
                </div>

                <!-- File List -->
                <div id="file-list-container" class="mt-6 hidden">
                    <h2 class="text-xl font-semibold mb-3">Your Files</h2>
                    <ul id="file-list" class="space-y-3"></ul>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-8 flex flex-col sm:flex-row gap-4 hidden">
                    <button id="export-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 text-lg">
                        {/* Content will be set by JS */}
                    </button>
                    <button id="reset-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 text-lg">
                        <i class="fa-solid fa-trash"></i>Reset All
                    </button>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Page Editor Modal -->
    <div id="page-editor-modal" class="modal-backdrop hidden opacity-0">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl flex flex-col p-6">
            <header class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
                <div>
                    <h2 class="text-2xl font-bold text-indigo-400">Page Editor</h2>
                    <p id="modal-filename" class="text-gray-400 truncate"></p>
                </div>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-2x"></i></button>
            </header>
            <div id="modal-body" class="flex-grow overflow-y-auto pr-2">
                <div id="page-grid-loader" class="flex justify-center items-center h-full flex-col gap-4">
                    <div class="loader"></div>
                    <p>Loading page previews...</p>
                </div>
                <div id="page-grid" class="hidden grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4"></div>
            </div>
            <footer class="mt-6 flex justify-end gap-4 border-t border-gray-700 pt-4">
                <button id="cancel-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="save-changes-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">Save Changes</button>
            </footer>
        </div>
    </div>

    <!-- General Modals -->
    <div id="loading-modal" class="modal-backdrop hidden"><div class="bg-gray-800 p-8 rounded-2xl flex items-center gap-4 shadow-xl"><div class="loader"></div><p id="loading-message" class="text-lg">Working...</p></div></div>
    <div id="error-modal" class="modal-backdrop hidden"><div class="bg-gray-800 p-8 rounded-2xl text-center max-w-sm"><i class="fa-solid fa-circle-exclamation text-4xl text-red-500 mb-3"></i><h3 class="text-xl font-bold">An Error Occurred</h3><p id="error-message" class="text-gray-300 my-2"></p><button id="close-error-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg">Close</button></div></div>

    <script>
        const { PDFDocument } = PDFLib;
        const pdfjsLib = window.pdfjsLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const actionButtons = document.getElementById('action-buttons');
        const exportBtn = document.getElementById('export-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Modals
        const pageEditorModal = document.getElementById('page-editor-modal');
        const loadingModal = document.getElementById('loading-modal');
        const errorModal = document.getElementById('error-modal');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const modalFilename = document.getElementById('modal-filename');
        const pageGrid = document.getElementById('page-grid');
        const pageGridLoader = document.getElementById('page-grid-loader');

        // State
        let files = [];
        let fileListSortable = null;
        let pageGridSortable = null;

        // --- Event Listeners ---
        browseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        dropZone.addEventListener('click', () => fileInput.click());
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        ['dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('border-indigo-400')));
        ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-indigo-400')));
        dropZone.addEventListener('drop', e => handleFileSelection(e.dataTransfer.files));
        fileInput.addEventListener('change', e => {
            handleFileSelection(e.target.files);
            e.target.value = '';
        });

        resetBtn.addEventListener('click', resetState);
        exportBtn.addEventListener('click', exportPdf);
        closeErrorBtn.addEventListener('click', () => toggleModal(errorModal, false));
        closeModalBtn.addEventListener('click', () => toggleModal(pageEditorModal, false));
        cancelModalBtn.addEventListener('click', () => toggleModal(pageEditorModal, false));

        // --- Core Functions ---
        async function handleFileSelection(selectedFiles) {
            toggleModal(loadingModal, true, "Processing files...");
            const pdfFiles = Array.from(selectedFiles).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
            if (pdfFiles.length === 0) {
                toggleModal(loadingModal, false);
                if (selectedFiles.length > 0) showError("Please select PDF files only.");
                return;
            }

            for (const file of pdfFiles) {
                try {
                    const buffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(buffer);
                    files.push({
                        id: `file-${Date.now()}-${Math.random()}`,
                        name: file.name,
                        originalBuffer: buffer,
                        pdfDoc: pdfDoc,
                        pageIndices: pdfDoc.getPageIndices(),
                    });
                } catch (e) {
                    showError(`Could not process "${file.name}". It might be corrupt or password-protected.`);
                }
            }
            toggleModal(loadingModal, false);
            updateUI();
        }

        function updateUI() {
            fileList.innerHTML = '';
            if (files.length > 0) {
                fileListContainer.classList.remove('hidden');
                actionButtons.classList.remove('hidden');
                
                // **FIX**: Update button text based on file count
                if (files.length === 1) {
                    exportBtn.innerHTML = `<i class="fa-solid fa-file-export"></i>Export as PDF`;
                } else {
                    exportBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i>Merge All PDFs`;
                }

                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item bg-gray-700/50 p-3 rounded-lg flex items-center justify-between gap-4';
                    li.dataset.id = file.id;
                    li.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden flex-grow">
                           <i class="fa-solid fa-grip-vertical text-gray-500 cursor-move"></i>
                           <i class="fa-regular fa-file-pdf text-indigo-400 text-xl"></i>
                           <span class="font-medium truncate">${file.name}</span>
                        </div>
                        <div class="flex items-center gap-4 flex-shrink-0">
                           <span class="text-sm text-gray-400">${file.pageIndices.length} pages</span>
                           <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md text-sm">Edit Pages</button>
                           <button class="remove-btn text-gray-400 hover:text-red-500"><i class="fas fa-times-circle fa-lg"></i></button>
                        </div>
                    `;
                    li.querySelector('.edit-btn').addEventListener('click', () => openPageEditor(file.id));
                    li.querySelector('.remove-btn').addEventListener('click', () => {
                        files = files.filter(f => f.id !== file.id);
                        updateUI();
                    });
                    fileList.appendChild(li);
                });

                if (fileListSortable) fileListSortable.destroy();
                fileListSortable = new Sortable(fileList, {
                    animation: 150,
                    handle: '.fa-grip-vertical',
                    onEnd: (evt) => {
                        const element = files.splice(evt.oldIndex, 1)[0];
                        files.splice(evt.newIndex, 0, element);
                    },
                });

            } else {
                fileListContainer.classList.add('hidden');
                actionButtons.classList.add('hidden');
            }
        }

        async function openPageEditor(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) return;

            modalFilename.textContent = file.name;
            pageGrid.innerHTML = '';
            pageGrid.classList.add('hidden');
            pageGridLoader.classList.remove('hidden');
            toggleModal(pageEditorModal, true);
            
            saveChangesBtn.onclick = () => savePageChanges(fileId);

            try {
                const pdfJSDoc = await pdfjsLib.getDocument({ data: file.originalBuffer }).promise;
                const pagePromises = file.pageIndices.map(async (originalIndex, displayIndex) => {
                    const page = await pdfJSDoc.getPage(originalIndex + 1);
                    const viewport = page.getViewport({ scale: 1 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    const thumb = document.createElement('div');
                    thumb.className = 'page-thumbnail cursor-move';
                    thumb.dataset.originalIndex = originalIndex;
                    thumb.innerHTML = `<div class="page-overlay"><span class="page-number">${displayIndex + 1}</span></div><button class="delete-page-btn"><i class="fas fa-times"></i></button>`;
                    thumb.prepend(canvas);
                    thumb.querySelector('.delete-page-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        thumb.remove();
                    });
                    return thumb;
                });

                const thumbnails = await Promise.all(pagePromises);
                pageGrid.append(...thumbnails);

                if (pageGridSortable) pageGridSortable.destroy();
                pageGridSortable = new Sortable(pageGrid, { animation: 150 });

                pageGridLoader.classList.add('hidden');
                pageGrid.classList.remove('hidden');
            } catch (e) {
                toggleModal(pageEditorModal, false);
                showError(`Failed to render pages for ${file.name}. The file might be corrupted.`);
                console.error(e);
            }
        }

        async function savePageChanges(fileId) {
            toggleModal(loadingModal, true, "Saving changes...");
            const file = files.find(f => f.id === fileId);
            const thumbnailElements = Array.from(pageGrid.children);
            const newPageIndices = thumbnailElements.map(t => parseInt(t.dataset.originalIndex));

            if (newPageIndices.length === 0) {
                 files = files.filter(f => f.id !== fileId);
            } else {
                file.pageIndices = newPageIndices;
            }
            
            toggleModal(loadingModal, false);
            toggleModal(pageEditorModal, false);
            updateUI();
        }

        async function exportPdf() {
            if (files.length < 1) {
                showError("Please add at least one file.");
                return;
            }

            // **FIX**: Check if a single file is unedited (same pages in same order)
            if (files.length === 1) {
                const file = files[0];
                const originalIndices = file.pdfDoc.getPageIndices();
                const currentIndices = file.pageIndices;
                const isUnchanged = originalIndices.length === currentIndices.length && originalIndices.every((val, index) => val === currentIndices[index]);
                if (isUnchanged) {
                    showError("No changes have been made to this file. Edit the pages to export.");
                    return;
                }
            }

            const isSingleFile = files.length === 1;
            const loadingText = isSingleFile ? "Exporting PDF..." : "Merging PDFs...";
            toggleModal(loadingModal, true, loadingText);

            try {
                const finalPdf = await PDFDocument.create();
                for (const file of files) { // files array is already sorted by SortableJS
                    const tempDoc = await PDFDocument.create();
                    const copiedPages = await tempDoc.copyPages(file.pdfDoc, file.pageIndices);
                    copiedPages.forEach(page => tempDoc.addPage(page));

                    const finalCopiedPages = await finalPdf.copyPages(tempDoc, tempDoc.getPageIndices());
                    finalCopiedPages.forEach(page => finalPdf.addPage(page));
                }

                if (finalPdf.getPageCount() === 0) {
                    showError('No pages were left to merge or export. Please check your selections.');
                    toggleModal(loadingModal, false);
                    return;
                }

                const finalPdfBytes = await finalPdf.save();
                
                // **FIX**: Use a dynamic filename
                const filename = isSingleFile 
                    ? `${files[0].name.replace(/\.pdf$/i, '')}-edited.pdf` 
                    : 'merged-document.pdf';

                const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
                
            } catch (e) {
                showError("A critical error occurred during the export process.");
                console.error(e);
            } finally {
                toggleModal(loadingModal, false);
            }
        }

        function resetState() {
            files = [];
            fileInput.value = '';
            updateUI();
        }

        // --- Utility Functions ---
        function toggleModal(modal, show, message = '') {
            if (show) {
                if (message) {
                    if (modal === loadingModal) loadingMessage.textContent = message;
                    if (modal === errorModal) errorMessage.textContent = message;
                }
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        function showError(message) { toggleModal(errorModal, true, message); }
    </script>
</body>
</html>
